#!/usr/bin/env bash
set -eu


SCRIPT_DIR="$(dirname "$(realpath "$0")")"
VENV_BASE=$HOME/.local/share/millennium/.venv
VENV_ACTIVATE=$VENV_BASE/bin/activate
PLUGINS_DIR=$HOME/.local/share/millennium/plugins


installmillennium(){
    echo "Installing Millennium..."
    curl -fsSL https://raw.githubusercontent.com/SteamClientHomebrew/Millennium/main/scripts/install.sh | bash
}

get_latest_release() {
    curl -sL "https://api.github.com/repos/ciscosweater/cyberia/releases/latest" | jq -r '.tag_name'
}

installcyberia(){
    local latest_tag version zip_path

    # Create venv if it doesn't exist
    if [ ! -f "$VENV_ACTIVATE" ]; then
        echo "Creating Python virtual environment..."
        python3 -m venv "$VENV_BASE"
    fi

    latest_tag=$(get_latest_release)
    version="${latest_tag#v}"
    zip_path="$SCRIPT_DIR/cyberia-v${version}.zip"

    echo "Downloading Latest Cyberia (${latest_tag})..."
    cd "$SCRIPT_DIR/"
    wget -q "https://github.com/ciscosweater/cyberia/releases/download/${latest_tag}/cyberia-v${version}.zip"

    echo "Extracting..."
    rm -rf "$PLUGINS_DIR/cyberia-v${version}"
    unzip -q -d "$PLUGINS_DIR/" "$zip_path"

    echo "Installing Dependencies..."
    source "$VENV_ACTIVATE"
    pip install -r "$PLUGINS_DIR/cyberia-v${version}/requirements.txt" &> /dev/null

    rm "$zip_path"
    echo "Launching Plugins Page - Activate Cyberia, Save and Reload."
    steam steam://millennium/settings/plugins &> /dev/null
}

installmillennium
installcyberia


